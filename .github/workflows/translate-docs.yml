name: Translate Korean Docs to English

on:
  push:
    branches: [ master, main ]
    paths:
      - 'docs/**/*.md'
  pull_request:
    branches: [ master, main ]
    paths:
      - 'docs/**/*.md'
  workflow_dispatch:
    inputs:
      force_translate:
        description: 'Force translate all files (ignore skip-existing)'
        required: false
        default: false
        type: boolean
      ssl_verify:
        description: 'Enable SSL certificate verification'
        required: false
        default: true
        type: boolean
permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    runs-on: macOS  # Use self-hosted runner for local Ollama access
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Ollama Server
      shell: bash
      run: |
        # Start Ollama server if not running
        if ! pgrep -x "ollama" > /dev/null; then
          echo "ðŸš€ Starting Ollama server..."
          ollama serve &
          sleep 10
        else
          echo "âœ… Ollama server is already running"
        fi
        
        # Verify server is accessible
        echo "ðŸ” Checking Ollama server accessibility..."
        for i in {1..5}; do
          if curl -s http://localhost:11434/api/tags > /dev/null; then
            echo "âœ… Ollama server is accessible"
            break
          else
            echo "â³ Waiting for Ollama server... (attempt $i/5)"
            sleep 2
          fi
        done

    - name: Translate Korean docs to English
      uses: ./  # Use the local action
      with:
        ollama-url: 'http://localhost:11434'
        model: 'huihui_ai/hunyuan-mt-abliterated:7b-chimera-q8_0'
        context-length: 4096
        source-dir: 'docs'
        target-dir: 'docs-en'
        file-pattern: '**/*.md'
        temperature: 0
        max-retries: 3
        skip-existing: ${{ !inputs.force_translate }}
        ssl-verify: ${{ inputs.ssl_verify }}
        create-pr: true
        pr-title: 'ðŸ“š Update English documentation translations'
        pr-branch: 'auto-translate-${{ github.run_number }}'
        base-branch: 'main'
        commit-message: 'docs: Auto-translate Korean documents to English'
        github-token: ${{ secrets.GITHUB_TOKEN }}
      id: translate

    - name: Upload translated files as artifact
      if: steps.translate.outputs.translated-files != '0'
      uses: actions/upload-artifact@v4
      with:
        name: translated-docs-${{ github.run_number }}
        path: docs-en/
        retention-days: 30
        if-no-files-found: warn

    - name: Translation Summary
      if: always()
      run: |
        echo "## ðŸ”„ Translation Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Translated files**: ${{ steps.translate.outputs.translated-files }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Skipped files**: ${{ steps.translate.outputs.skipped-files }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -n "${{ steps.translate.outputs.pr-url }}" ]; then
          echo "- **Pull Request**: [${{ steps.translate.outputs.pr-number }}](${{ steps.translate.outputs.pr-url }})" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ steps.translate.outputs.translated-files }}" != "0" ]; then
          echo "- **Artifact**: Translated files uploaded as artifact 'translated-docs-${{ github.run_number }}'" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Result**: No changes detected" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Workflow Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
